name: CD Pipeline - 4th.GRC

on:
  workflow_run:
    workflows: ["CI Pipeline - 4th.GRC"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      RESOURCE_GROUP: 4thGRC-RG
      CONTAINERAPP_ENV: 4thGRC-Env
      ACR_NAME: fourthindustrial
      IMAGE_NAME: policyengine_svc
      IMAGE_TAG: latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ env.AZURE_CREDENTIALS }}

      - name: Build Docker image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG -f services/policyengine_svc/Dockerfile .

      - name: Push image to ACR
        run: |
          az acr login --name $ACR_NAME
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update             --name policyengine-svc             --resource-group $RESOURCE_GROUP             --image $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG             --min-replicas 1 --max-replicas 3

      - name: Publish OpenAPI Spec to APIM
        run: |
          python scripts/publish_openapi.py

      - name: Logout of Azure
        run: az logout
